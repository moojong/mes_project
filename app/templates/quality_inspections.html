{% set page_title = "품질검사" %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>{{ page_title }} | MES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table td, .table th { vertical-align: middle; }
    .form-section-title { font-weight: 600; margin-bottom: .5rem; }
    .w-140 { width: 140px; }
  </style>
</head>
<body class="bg-light">

<!-- 상단 네비게이션 -->
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-3">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">MES</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
            aria-controls="mainNav" aria-expanded="false" aria-label="토글">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" href="/dashboard">대시보드</a>
        </li>

        <!-- 생산관리 드롭다운 -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarWork" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            생산관리
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarWork">
            <li><a class="dropdown-item" href="/work/orders">작업지시</a></li>
            <li><a class="dropdown-item" href="/work/progress">공정진행</a></li>
            <li><a class="dropdown-item" href="/work/results">생산실적</a></li>
          </ul>
        </li>

        <!-- 품질관리 드롭다운 -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle active" href="#" id="navbarQuality" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            품질관리
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarQuality">
            <li><a class="dropdown-item active" href="/work/inspections">품질검사 등록</a></li>
            <li><a class="dropdown-item" href="/work/quality_results">품질검사 결과</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- 페이지 헤더 -->
<div class="container">
  <h4 class="mb-3">{{ page_title }}</h4>

  <!-- 신규 품질검사 카드 -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="form-section-title">신규 품질검사</div>
      <form method="post" action="/work/inspections">
        <div class="row g-3">
          <!-- 작업지시 -->
          <div class="col-md-3">
            <label class="form-label">작업지시</label>
            <select class="form-select" name="order_id" id="order_id" required>
              <option value="" selected>선택...</option>
              {% for o in orders %}
              <!-- 서버에서 orders: [{order_id, product_id, product_name, planned_qty, ...}] 형태로 전달 -->
              <option
                value="{{ o.order_id }}"
                data-product-id="{{ o.product_id }}"
                data-product-name="{{ o.product_name|default('', true) }}"
              >
                {{ o.order_id }}
              </option>
              {% endfor %}
            </select>
          </div>

          <!-- 제품: 자동 채움/읽기전용 -->
          <div class="col-md-3">
            <label class="form-label">제품</label>
            <input type="text" class="form-control" id="product_name" placeholder="자동 채움" readonly>
            <input type="hidden" name="product_id" id="product_id">
          </div>

          <!-- 검사수량 -->
          <div class="col-md-2">
            <label class="form-label">검사수량</label>
            <input type="number" class="form-control" name="inspection_qty" value="10" min="1" required>
          </div>

          <!-- 검사자 -->
          <div class="col-md-2">
            <label class="form-label">검사자</label>
            <input type="text" class="form-control" name="inspector" placeholder="이름">
          </div>

          <!-- 검사예정일 -->
          <div class="col-md-2">
            <label class="form-label">검사예정일</label>
            <input type="date" class="form-control" name="inspection_date">
          </div>

          <!-- 비고 -->
          <div class="col-12">
            <label class="form-label">비고</label>
            <textarea class="form-control" name="notes" rows="2" placeholder="메모(선택)"></textarea>
          </div>

          <div class="col-12 d-flex align-items-center gap-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="1" id="urgent" name="urgent">
              <label class="form-check-label" for="urgent">긴급</label>
            </div>
            <button type="submit" class="btn btn-primary px-4">등록</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- 목록 카드 -->
  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="form-section-title">검사 목록</div>
        <div class="text-muted small">총 {{ inspections|length }}건</div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th class="w-140">검사 ID</th>
              <th>작업지시</th>
              <th>제품</th>
              <th class="text-end">검사수량</th>
              <th>검사자</th>
              <th class="w-140">검사예정일</th>
              <th class="w-100">상태</th>
            </tr>
          </thead>
          <tbody>
            {% for r in inspections %}
            <tr>
              <td>
                <a href="/work/inspections/{{ r.inspection_id }}">
                  {{ r.inspection_id }}
                </a>
              </td>
              <td>{{ r.order_id }}</td>
              <td>{{ r.product_name or r.product_id }}</td>
              <td class="text-end">{{ r.inspection_qty }}</td>
              <td>{{ r.inspector or '-' }}</td>
              <td>{{ r.inspection_date.strftime('%Y-%m-%d') if r.inspection_date else '-' }}</td>
              <td>
                {% set badge = 'success' if r.status in ['완료','COMPLETE','DONE','OK'] else
